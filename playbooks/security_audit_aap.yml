---
- name: AAP OpenShift Security Audit (Full Coverage)
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    target_namespace: "all"
    system_namespaces_regex: "^(openshift-|kube-|default$|logging$|monitoring$)"
    # Lista de Capabilities perigosas (Red Hat Best Practices)
    dangerous_caps: ['SYS_ADMIN', 'NET_ADMIN', 'IPC_LOCK', 'SYS_PTRACE', 'DAC_OVERRIDE']

  tasks:
    # ==============================================================================
    # FASE 1: COLETA (Pods e NetworkPolicies)
    # ==============================================================================
    - name: 1.1 Coletar Pods
      kubernetes.core.k8s_info:
        kind: Pod
        api_version: v1
        namespace: "{{ target_namespace if target_namespace != 'all' else omit }}"
      register: fetched_pods

    - name: 1.2 Coletar NetworkPolicies (Para auditoria de rede)
      kubernetes.core.k8s_info:
        kind: NetworkPolicy
        api_version: networking.k8s.io/v1
        namespace: "{{ target_namespace if target_namespace != 'all' else omit }}"
      register: fetched_netpols

    - name: 2. Filtrar Escopo e Namespaces Ãšnicos
      set_fact:
        # Lista de Pods filtrada (sem sistema)
        audit_scope_pods: >-
          {{
            fetched_pods.resources 
            | rejectattr('metadata.namespace', 'match', system_namespaces_regex)
            | list
            if target_namespace == 'all' 
            else fetched_pods.resources
          }}
        # Lista de Namespaces Ãºnicos encontrados no escopo (para checar NetPol)
        audit_unique_namespaces: >-
          {{
            fetched_pods.resources 
            | rejectattr('metadata.namespace', 'match', system_namespaces_regex)
            | map(attribute='metadata.namespace')
            | unique
            | list
            if target_namespace == 'all'
            else [target_namespace]
          }}

    # ==============================================================================
    # FASE 2: CÃLCULO (PODS + NAMESPACES)
    # ==============================================================================
    - name: 3. Inicializar VariÃ¡veis
      set_fact:
        v_privileged: []
        v_hostpath: []
        v_latest: []
        v_probes: []
        v_limits: []
        v_caps: []    # Nova: Capabilities
        v_netpol: []  # Nova: Namespaces sem NetworkPolicy

    - name: 4. Processar Auditoria de PODS (Loop)
      set_fact:
        # (Existentes...)
        v_privileged: "{{ v_privileged + ([item.metadata.namespace ~ '/' ~ item.metadata.name] if (item.spec.containers | selectattr('securityContext.privileged', 'defined') | selectattr('securityContext.privileged', 'equalto', true) | list | length > 0) else []) }}"
        v_hostpath:   "{{ v_hostpath   + ([item.metadata.namespace ~ '/' ~ item.metadata.name] if (item.spec.volumes is defined and item.spec.volumes | selectattr('hostPath', 'defined') | list | length > 0) else []) }}"
        v_latest:     "{{ v_latest     + ([item.metadata.namespace ~ '/' ~ item.metadata.name] if (item.spec.containers | selectattr('image', 'search', ':latest$') | list | length > 0 or item.spec.containers | rejectattr('image', 'search', ':') | list | length > 0) else []) }}"
        v_probes:     "{{ v_probes     + ([item.metadata.namespace ~ '/' ~ item.metadata.name] if (item.spec.containers | selectattr('livenessProbe', 'undefined') | list | length > 0 or item.spec.containers | selectattr('readinessProbe', 'undefined') | list | length > 0) else []) }}"
        v_limits:     "{{ v_limits     + ([item.metadata.namespace ~ '/' ~ item.metadata.name] if (item.spec.containers | selectattr('resources.limits', 'undefined') | list | length > 0) else []) }}"
        
        # (NOVO) Check Capabilities: Verifica se alguma cap adicionada estÃ¡ na lista proibida
        v_caps: >-
          {{ v_caps + 
             ([item.metadata.namespace ~ '/' ~ item.metadata.name ~ ' (' ~ 
               (item.spec.containers 
                | selectattr('securityContext.capabilities.add', 'defined') 
                | map(attribute='securityContext.capabilities.add') 
                | flatten 
                | intersect(dangerous_caps) 
                | join(',')
               ) ~ ')']
              if (
                item.spec.containers 
                | selectattr('securityContext.capabilities.add', 'defined') 
                | map(attribute='securityContext.capabilities.add') 
                | flatten 
                | intersect(dangerous_caps) 
                | length > 0
              ) 
              else []) 
          }}
      loop: "{{ audit_scope_pods }}"
      loop_control:
        label: "Checking {{ item.metadata.name }}"

    - name: 5. Processar Auditoria de REDE (Namespaces sem Policy)
      # LÃ³gica: Pega a lista de namespaces que tÃªm pods. Subtrai a lista de namespaces que tÃªm NetworkPolicies.
      set_fact:
        v_netpol: >-
          {{
            audit_unique_namespaces 
            | difference(fetched_netpols.resources | map(attribute='metadata.namespace') | unique)
            | list
          }}

    # ==============================================================================
    # FASE 3: EXIBIÃ‡ÃƒO MODULAR
    # ==============================================================================
    
    - name: "CABEÃ‡ALHO DO RELATÃ“RIO"
      debug:
        msg: 
          - "############################################################"
          - "              AUDITORIA: {{ target_namespace | upper }}"
          - "############################################################"

    # --- 1. PRIVILEGED ---
    - name: "RESULTADO [1/7]: Containers Privilegiados"
      debug:
        msg: "{{ title + content }}"
      vars:
        count: "{{ v_privileged | length }}"
        is_nok: "{{ count | int > 0 }}"
        title: ["{{ 'ðŸ”´ NOK' if is_nok else 'ðŸŸ¢ OK' }} - Violations: {{ count }}"]
        content: "{{ v_privileged if is_nok else ['   -> âœ… Nenhum container privilegiado.'] }}"

    # --- 2. CAPABILITIES (NOVO) ---
    - name: "RESULTADO [2/7]: Dangerous Capabilities ({{ dangerous_caps | join(',') }})"
      debug:
        msg: "{{ title + content }}"
      vars:
        count: "{{ v_caps | length }}"
        is_nok: "{{ count | int > 0 }}"
        title: ["{{ 'ðŸ”´ NOK' if is_nok else 'ðŸŸ¢ OK' }} - Violations: {{ count }}"]
        content: "{{ v_caps if is_nok else ['   -> âœ… Nenhuma capability perigosa detectada.'] }}"

    # --- 3. NETWORK POLICIES (NOVO) ---
    - name: "RESULTADO [3/7]: Namespaces SEM NetworkPolicy (Isolamento)"
      debug:
        msg: "{{ title + content }}"
      vars:
        count: "{{ v_netpol | length }}"
        is_nok: "{{ count | int > 0 }}"
        title: ["{{ 'ðŸ”´ NOK' if is_nok else 'ðŸŸ¢ OK' }} - Violations: {{ count }}"]
        content: "{{ v_netpol if is_nok else ['   -> âœ… Todos os namespaces auditados possuem NetworkPolicies.'] }}"

    # --- 4. HOSTPATH ---
    - name: "RESULTADO [4/7]: Volumes HostPath"
      debug:
        msg: "{{ title + content }}"
      vars:
        count: "{{ v_hostpath | length }}"
        is_nok: "{{ count | int > 0 }}"
        title: ["{{ 'ðŸ”´ NOK' if is_nok else 'ðŸŸ¢ OK' }} - Violations: {{ count }}"]
        content: "{{ v_hostpath if is_nok else ['   -> âœ… Nenhum HostPath detectado.'] }}"

    # --- 5. LATEST TAG ---
    - name: "RESULTADO [5/7]: Imagens Tag ':latest'"
      debug:
        msg: "{{ title + content }}"
      vars:
        count: "{{ v_latest | length }}"
        is_nok: "{{ count | int > 0 }}"
        title: ["{{ 'ðŸ”´ NOK' if is_nok else 'ðŸŸ¢ OK' }} - Violations: {{ count }}"]
        content: "{{ v_latest if is_nok else ['   -> âœ… Todas as imagens versionadas.'] }}"

    # --- 6. PROBES ---
    - name: "RESULTADO [6/7]: Health Probes Ausentes"
      debug:
        msg: "{{ title + content }}"
      vars:
        count: "{{ v_probes | length }}"
        is_nok: "{{ count | int > 0 }}"
        title: ["{{ 'ðŸ”´ NOK' if is_nok else 'ðŸŸ¢ OK' }} - Violations: {{ count }}"]
        content: "{{ v_probes if is_nok else ['   -> âœ… Todos os pods possuem Probes.'] }}"

    # --- 7. LIMITS ---
    - name: "RESULTADO [7/7]: Resource Limits Ausentes"
      debug:
        msg: "{{ title + content }}"
      vars:
        count: "{{ v_limits | length }}"
        is_nok: "{{ count | int > 0 }}"
        title: ["{{ 'ðŸ”´ NOK' if is_nok else 'ðŸŸ¢ OK' }} - Violations: {{ count }}"]
        content: "{{ v_limits if is_nok else ['   -> âœ… Todos os pods possuem limites.'] }}"

    - name: "FIM DO RELATÃ“RIO"
      debug:
        msg: "############################################################"
