---
- name: AAP OpenShift Security Audit (NOK/OK Report)
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    # INPUT: Variavel que vem do Survey do AAP
    target_namespace: "all"
    system_namespaces_regex: "^(openshift-|kube-|default$|logging$|monitoring$)"

  tasks:
    # ==============================================================================
    # FASE 1: COLETA DE DADOS
    # ==============================================================================
    - name: 1. Coletar Pods (Otimizado)
      kubernetes.core.k8s_info:
        kind: Pod
        api_version: v1
        namespace: "{{ target_namespace if target_namespace != 'all' else omit }}"
      register: fetched_pods

    - name: 2. Definir Escopo (Filtrar Sistema)
      set_fact:
        audit_scope_pods: >-
          {{
            fetched_pods.resources 
            | rejectattr('metadata.namespace', 'match', system_namespaces_regex)
            | list
            if target_namespace == 'all' 
            else fetched_pods.resources
          }}

    # ==============================================================================
    # FASE 2: VERIFICAÃ‡Ã•ES (Gera listas de violacoes)
    # ==============================================================================
    - name: 3. Check - Containers Privilegiados
      set_fact:
        # Cria uma lista de strings: "namespace/pod"
        violators_privileged: >-
          {{
            audit_scope_pods 
            | selectattr('spec.containers', 'defined')
            | map(attribute='spec.containers')
            | flatten
            | selectattr('securityContext.privileged', 'defined')
            | selectattr('securityContext.privileged', 'equalto', true)
            | map('image') 
            | list
            | length > 0 
            | ternary(
                audit_scope_pods 
                | selectattr('spec.containers', 'defined') 
                | select('json_query', "spec.containers[?securityContext.privileged==`true`]") 
                | map(attribute='metadata') 
                | map('json_query', "{ns: namespace, name: name}") 
                | map('join', '/') 
                | list, 
                []
              )
          }}
      # Nota: A logica acima usa json_query/select complexo para garantir precisÃ£o, 
      # mas para simplificar e garantir que nada quebre, vou usar a logica de loop anterior que era mais robusta.
      # Vamos reverter para o loop set_fact que Ã© infalÃ­vel.

    # --- RESET DA ABORDAGEM DE LOOP (Mais seguro contra erros de Jinja) ---
    
    - name: Reset das variaveis de violacao
      set_fact:
        v_privileged: []
        v_hostpath: []
        v_latest: []
        v_probes: []
        v_limits: []

    - name: 3.1 Loop de Auditoria (Processa tudo de uma vez)
      set_fact:
        v_privileged: "{{ v_privileged + ([item.metadata.namespace ~ '/' ~ item.metadata.name] if (item.spec.containers | selectattr('securityContext.privileged', 'defined') | selectattr('securityContext.privileged', 'equalto', true) | list | length > 0) else []) }}"
        v_hostpath:   "{{ v_hostpath   + ([item.metadata.namespace ~ '/' ~ item.metadata.name] if (item.spec.volumes is defined and item.spec.volumes | selectattr('hostPath', 'defined') | list | length > 0) else []) }}"
        v_latest:     "{{ v_latest     + ([item.metadata.namespace ~ '/' ~ item.metadata.name] if (item.spec.containers | selectattr('image', 'search', ':latest$') | list | length > 0 or item.spec.containers | rejectattr('image', 'search', ':') | list | length > 0) else []) }}"
        v_probes:     "{{ v_probes     + ([item.metadata.namespace ~ '/' ~ item.metadata.name] if (item.spec.containers | selectattr('livenessProbe', 'undefined') | list | length > 0 or item.spec.containers | selectattr('readinessProbe', 'undefined') | list | length > 0) else []) }}"
        v_limits:     "{{ v_limits     + ([item.metadata.namespace ~ '/' ~ item.metadata.name] if (item.spec.containers | selectattr('resources.limits', 'undefined') | list | length > 0) else []) }}"
      loop: "{{ audit_scope_pods }}"
      loop_control:
        label: "Auditando {{ item.metadata.name }}"

    # ==============================================================================
    # FASE 3: CONSTRUÃ‡ÃƒO DO RELATÃ“RIO (Monta a lista final)
    # ==============================================================================
    
    - name: Construir CabeÃ§alho
      set_fact:
        final_report:
          - "############################################################"
          - "              RELATÃ“RIO DE AUDITORIA: {{ target_namespace | upper }}"
          - "############################################################"
          - " "

    - name: Adicionar SeÃ§Ã£o Privileged
      set_fact:
        final_report: "{{ final_report + section_header + section_list + [' '] }}"
      vars:
        is_nok: "{{ v_privileged | length > 0 }}"
        section_header: 
          - "{{ 'ðŸ”´ NOK' if is_nok else 'ðŸŸ¢ OK' }} - Containers Privilegiados: {{ v_privileged | length }} encontrado(s)"
        section_list: "{{ v_privileged if is_nok else ['   -> Nenhum container privilegiado detectado.'] }}"

    - name: Adicionar SeÃ§Ã£o HostPath
      set_fact:
        final_report: "{{ final_report + section_header + section_list + [' '] }}"
      vars:
        is_nok: "{{ v_hostpath | length > 0 }}"
        section_header: 
          - "{{ 'ðŸ”´ NOK' if is_nok else 'ðŸŸ¢ OK' }} - Volumes HostPath (Risco Alto): {{ v_hostpath | length }} encontrado(s)"
        section_list: "{{ v_hostpath if is_nok else ['   -> Nenhum volume HostPath detectado.'] }}"

    - name: Adicionar SeÃ§Ã£o Latest Tag
      set_fact:
        final_report: "{{ final_report + section_header + section_list + [' '] }}"
      vars:
        is_nok: "{{ v_latest | length > 0 }}"
        section_header: 
          - "{{ 'ðŸ”´ NOK' if is_nok else 'ðŸŸ¢ OK' }} - Imagens com tag ':latest': {{ v_latest | length }} encontrado(s)"
        section_list: "{{ v_latest if is_nok else ['   -> Todas as imagens estÃ£o versionadas.'] }}"

    - name: Adicionar SeÃ§Ã£o Probes
      set_fact:
        final_report: "{{ final_report + section_header + section_list + [' '] }}"
      vars:
        is_nok: "{{ v_probes | length > 0 }}"
        section_header: 
          - "{{ 'ðŸ”´ NOK' if is_nok else 'ðŸŸ¢ OK' }} - Pods sem Probes (SaÃºde): {{ v_probes | length }} encontrado(s)"
        section_list: "{{ v_probes if is_nok else ['   -> Todos os pods tÃªm verificaÃ§Ã£o de saÃºde.'] }}"

    - name: Adicionar SeÃ§Ã£o Limits (QoS)
      set_fact:
        final_report: "{{ final_report + section_header + section_list + [' '] }}"
      vars:
        is_nok: "{{ v_limits | length > 0 }}"
        section_header: 
          - "{{ 'ðŸ”´ NOK' if is_nok else 'ðŸŸ¢ OK' }} - Pods sem Resource Limits: {{ v_limits | length }} encontrado(s)"
        section_list: "{{ v_limits if is_nok else ['   -> Todos os pods tÃªm limites de recursos definidos.'] }}"

    - name: Finalizar RodapÃ©
      set_fact:
        final_report: "{{ final_report + ['############################################################'] }}"

    # ==============================================================================
    # FASE 4: EXIBIÃ‡ÃƒO
    # ==============================================================================
    - name: "ðŸ“‹ EXIBIR RELATÃ“RIO COMPLETO"
      debug:
        msg: "{{ final_report }}"
