---
- name: AAP OpenShift Security Audit (Final Fix)
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    target_namespace: "all"
    system_namespaces_regex: "^(openshift-|kube-|default$|logging$|monitoring$)"

  tasks:
    # ==============================================================================
    # FASE 1: COLETA
    # ==============================================================================
    - name: 1. Coletar Pods
      kubernetes.core.k8s_info:
        kind: Pod
        api_version: v1
        namespace: "{{ target_namespace if target_namespace != 'all' else omit }}"
      register: fetched_pods

    - name: 2. Filtrar Escopo
      set_fact:
        audit_scope_pods: >-
          {{
            fetched_pods.resources 
            | rejectattr('metadata.namespace', 'match', system_namespaces_regex)
            | list
            if target_namespace == 'all' 
            else fetched_pods.resources
          }}

    # ==============================================================================
    # FASE 2: CÃLCULO (LOOP)
    # ==============================================================================
    - name: 3. Inicializar VariÃ¡veis
      set_fact:
        v_privileged: []
        v_hostpath: []
        v_latest: []
        v_probes: []
        v_limits: []

    - name: 4. Processar Auditoria
      set_fact:
        v_privileged: "{{ v_privileged + ([item.metadata.namespace ~ '/' ~ item.metadata.name] if (item.spec.containers | selectattr('securityContext.privileged', 'defined') | selectattr('securityContext.privileged', 'equalto', true) | list | length > 0) else []) }}"
        v_hostpath:   "{{ v_hostpath   + ([item.metadata.namespace ~ '/' ~ item.metadata.name] if (item.spec.volumes is defined and item.spec.volumes | selectattr('hostPath', 'defined') | list | length > 0) else []) }}"
        v_latest:     "{{ v_latest     + ([item.metadata.namespace ~ '/' ~ item.metadata.name] if (item.spec.containers | selectattr('image', 'search', ':latest$') | list | length > 0 or item.spec.containers | rejectattr('image', 'search', ':') | list | length > 0) else []) }}"
        v_probes:     "{{ v_probes     + ([item.metadata.namespace ~ '/' ~ item.metadata.name] if (item.spec.containers | selectattr('livenessProbe', 'undefined') | list | length > 0 or item.spec.containers | selectattr('readinessProbe', 'undefined') | list | length > 0) else []) }}"
        v_limits:     "{{ v_limits     + ([item.metadata.namespace ~ '/' ~ item.metadata.name] if (item.spec.containers | selectattr('resources.limits', 'undefined') | list | length > 0) else []) }}"
      loop: "{{ audit_scope_pods }}"
      loop_control:
        label: "Checking {{ item.metadata.name }}"

    # ==============================================================================
    # FASE 3: EXIBIÃ‡ÃƒO MODULAR (CORRIGIDA COM | int)
    # ==============================================================================
    
    - name: "CABEÃ‡ALHO DO RELATÃ“RIO"
      debug:
        msg: 
          - "############################################################"
          - "              AUDITORIA: {{ target_namespace | upper }}"
          - "############################################################"

    # --- BLOCO 1: PRIVILEGED ---
    - name: "RESULTADO [1/5]: Containers Privilegiados"
      debug:
        msg: "{{ title + content }}"
      vars:
        count: "{{ v_privileged | length }}"
        # CORREÃ‡ÃƒO AQUI: Adicionado '| int' para garantir que Ã© numero
        is_nok: "{{ count | int > 0 }}"
        title: 
          - "{{ 'ðŸ”´ NOK' if is_nok else 'ðŸŸ¢ OK' }} - Violations: {{ count }}"
        content: "{{ v_privileged if is_nok else ['   -> âœ… Nenhum container privilegiado (OK).'] }}"

    # --- BLOCO 2: HOSTPATH ---
    - name: "RESULTADO [2/5]: Volumes HostPath"
      debug:
        msg: "{{ title + content }}"
      vars:
        count: "{{ v_hostpath | length }}"
        is_nok: "{{ count | int > 0 }}"
        title: 
          - "{{ 'ðŸ”´ NOK' if is_nok else 'ðŸŸ¢ OK' }} - Violations: {{ count }}"
        content: "{{ v_hostpath if is_nok else ['   -> âœ… Nenhum HostPath detectado (OK).'] }}"

    # --- BLOCO 3: IMAGEM LATEST ---
    - name: "RESULTADO [3/5]: Imagens Tag ':latest'"
      debug:
        msg: "{{ title + content }}"
      vars:
        count: "{{ v_latest | length }}"
        is_nok: "{{ count | int > 0 }}"
        title: 
          - "{{ 'ðŸ”´ NOK' if is_nok else 'ðŸŸ¢ OK' }} - Violations: {{ count }}"
        content: "{{ v_latest if is_nok else ['   -> âœ… Todas as imagens versionadas (OK).'] }}"

    # --- BLOCO 4: PROBES ---
    - name: "RESULTADO [4/5]: Health Probes Ausentes"
      debug:
        msg: "{{ title + content }}"
      vars:
        count: "{{ v_probes | length }}"
        is_nok: "{{ count | int > 0 }}"
        title: 
          - "{{ 'ðŸ”´ NOK' if is_nok else 'ðŸŸ¢ OK' }} - Violations: {{ count }}"
        content: "{{ v_probes if is_nok else ['   -> âœ… Todos os pods possuem Probes (OK).'] }}"

    # --- BLOCO 5: LIMITS ---
    - name: "RESULTADO [5/5]: Resource Limits Ausentes"
      debug:
        msg: "{{ title + content }}"
      vars:
        count: "{{ v_limits | length }}"
        is_nok: "{{ count | int > 0 }}"
        title: 
          - "{{ 'ðŸ”´ NOK' if is_nok else 'ðŸŸ¢ OK' }} - Violations: {{ count }}"
        content: "{{ v_limits if is_nok else ['   -> âœ… Todos os pods possuem limites (OK).'] }}"

    - name: "FIM DO RELATÃ“RIO"
      debug:
        msg: "############################################################"
