---
- name: AAP OpenShift Security Audit (Stable Version)
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    # INPUT: Variavel que vem do Survey do AAP
    target_namespace: "all"
    # Regex para ignorar namespaces de sistema
    system_namespaces_regex: "^(openshift-|kube-|default$|logging$|monitoring$)"

  tasks:
    # ==============================================================================
    # FASE 1: COLETA DE DADOS
    # ==============================================================================
    - name: 1. Coletar Pods
      kubernetes.core.k8s_info:
        kind: Pod
        api_version: v1
        namespace: "{{ target_namespace if target_namespace != 'all' else omit }}"
      register: fetched_pods

    - name: 2. Filtrar Escopo
      set_fact:
        audit_scope_pods: >-
          {{
            fetched_pods.resources 
            | rejectattr('metadata.namespace', 'match', system_namespaces_regex)
            | list
            if target_namespace == 'all' 
            else fetched_pods.resources
          }}

    # ==============================================================================
    # FASE 2: AUDITORIA (MÃ‰TODO LOOP SEGURO)
    # ==============================================================================
    
    - name: 3. Inicializar Listas de ViolaÃ§Ã£o (Reset)
      set_fact:
        v_privileged: []
        v_hostpath: []
        v_latest: []
        v_probes: []
        v_limits: []

    - name: 4. Executar Auditoria (Iterando sobre os Pods)
      set_fact:
        # Verifica Privilegiados
        v_privileged: "{{ v_privileged + ([item.metadata.namespace ~ '/' ~ item.metadata.name] if (item.spec.containers | selectattr('securityContext.privileged', 'defined') | selectattr('securityContext.privileged', 'equalto', true) | list | length > 0) else []) }}"
        
        # Verifica HostPath
        v_hostpath:   "{{ v_hostpath   + ([item.metadata.namespace ~ '/' ~ item.metadata.name] if (item.spec.volumes is defined and item.spec.volumes | selectattr('hostPath', 'defined') | list | length > 0) else []) }}"
        
        # Verifica Tag Latest
        v_latest:     "{{ v_latest     + ([item.metadata.namespace ~ '/' ~ item.metadata.name] if (item.spec.containers | selectattr('image', 'search', ':latest$') | list | length > 0 or item.spec.containers | rejectattr('image', 'search', ':') | list | length > 0) else []) }}"
        
        # Verifica Probes
        v_probes:     "{{ v_probes     + ([item.metadata.namespace ~ '/' ~ item.metadata.name] if (item.spec.containers | selectattr('livenessProbe', 'undefined') | list | length > 0 or item.spec.containers | selectattr('readinessProbe', 'undefined') | list | length > 0) else []) }}"
        
        # Verifica Limits
        v_limits:     "{{ v_limits     + ([item.metadata.namespace ~ '/' ~ item.metadata.name] if (item.spec.containers | selectattr('resources.limits', 'undefined') | list | length > 0) else []) }}"
      
      loop: "{{ audit_scope_pods }}"
      loop_control:
        label: "Auditando {{ item.metadata.name }}"

    # ==============================================================================
    # FASE 3: CONSTRUÃ‡ÃƒO DO RELATÃ“RIO
    # ==============================================================================
    
    - name: Montar CabeÃ§alho
      set_fact:
        final_report:
          - "############################################################"
          - "              RELATÃ“RIO DE AUDITORIA: {{ target_namespace | upper }}"
          - "############################################################"
          - " "

    - name: Adicionar SeÃ§Ã£o Privileged
      set_fact:
        final_report: "{{ final_report + section_header + section_list + [' '] }}"
      vars:
        is_nok: "{{ v_privileged | length > 0 }}"
        section_header: 
          - "{{ 'ðŸ”´ NOK' if is_nok else 'ðŸŸ¢ OK' }} - Containers Privilegiados: {{ v_privileged | length }} encontrado(s)"
        section_list: "{{ v_privileged if is_nok else ['   -> Nenhum container privilegiado detectado.'] }}"

    - name: Adicionar SeÃ§Ã£o HostPath
      set_fact:
        final_report: "{{ final_report + section_header + section_list + [' '] }}"
      vars:
        is_nok: "{{ v_hostpath | length > 0 }}"
        section_header: 
          - "{{ 'ðŸ”´ NOK' if is_nok else 'ðŸŸ¢ OK' }} - Volumes HostPath: {{ v_hostpath | length }} encontrado(s)"
        section_list: "{{ v_hostpath if is_nok else ['   -> Nenhum volume HostPath detectado.'] }}"

    - name: Adicionar SeÃ§Ã£o Latest Tag
      set_fact:
        final_report: "{{ final_report + section_header + section_list + [' '] }}"
      vars:
        is_nok: "{{ v_latest | length > 0 }}"
        section_header: 
          - "{{ 'ðŸ”´ NOK' if is_nok else 'ðŸŸ¢ OK' }} - Imagens tag ':latest': {{ v_latest | length }} encontrado(s)"
        section_list: "{{ v_latest if is_nok else ['   -> Todas as imagens estÃ£o versionadas.'] }}"

    - name: Adicionar SeÃ§Ã£o Probes
      set_fact:
        final_report: "{{ final_report + section_header + section_list + [' '] }}"
      vars:
        is_nok: "{{ v_probes | length > 0 }}"
        section_header: 
          - "{{ 'ðŸ”´ NOK' if is_nok else 'ðŸŸ¢ OK' }} - Pods sem Probes: {{ v_probes | length }} encontrado(s)"
        section_list: "{{ v_probes if is_nok else ['   -> Todos os pods tÃªm verificaÃ§Ã£o de saÃºde.'] }}"

    - name: Adicionar SeÃ§Ã£o Limits
      set_fact:
        final_report: "{{ final_report + section_header + section_list + [' '] }}"
      vars:
        is_nok: "{{ v_limits | length > 0 }}"
        section_header: 
          - "{{ 'ðŸ”´ NOK' if is_nok else 'ðŸŸ¢ OK' }} - Pods sem Resource Limits: {{ v_limits | length }} encontrado(s)"
        section_list: "{{ v_limits if is_nok else ['   -> Todos os pods tÃªm limites de recursos definidos.'] }}"

    - name: Finalizar RelatÃ³rio
      set_fact:
        final_report: "{{ final_report + ['############################################################'] }}"

    # ==============================================================================
    # FASE 4: EXIBIÃ‡ÃƒO
    # ==============================================================================
    - name: "ðŸ“‹ EXIBIR RELATÃ“RIO COMPLETO"
      debug:
        msg: "{{ final_report }}"
