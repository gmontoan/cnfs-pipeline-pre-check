---
- name: "Relatório v18: Dashboard Completo (Safe Copy)"
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    # --- VARIÁVEIS DE HARDWARE ---
    total_cpu_alloc: 0
    total_mem_alloc: 0
    total_disk_alloc: 0
    
    # --- VARIÁVEIS DE CONSUMO ---
    used_cpu_req: 0
    used_mem_req: 0
    used_disk_req: 0

    # Listas auxiliares
    all_containers_list: []
    sriov_messages: []

  tasks:
    # ==============================================================================
    # 1. COLETA DE DADOS
    # ==============================================================================
    - name: "1.1 Buscar Nodes"
      kubernetes.core.k8s_info:
        kind: Node
        api_version: v1
      register: node_list

    - name: "1.2 Buscar Pods em Execução"
      kubernetes.core.k8s_info:
        kind: Pod
        api_version: v1
        field_selectors:
          - status.phase=Running
      register: all_pods

    - name: "1.3 Buscar SR-IOV"
      kubernetes.core.k8s_info:
        api_version: sriovnetwork.openshift.io/v1
        kind: SriovNetworkNodePolicy
        namespace: openshift-sriov
      register: sriov_policies
      failed_when: false

    # ==============================================================================
    # 2. CÁLCULOS DE CAPACIDADE (HARDWARE)
    # ==============================================================================
    - name: "2.1 Somar Capacidade dos Nodes"
      set_fact:
        total_cpu_alloc: >-
          {{ total_cpu_alloc | float + (item.status.allocatable.cpu | regex_replace('m','') | float / 1000 if 'm' in item.status.allocatable.cpu else item.status.allocatable.cpu | float) }}
        total_mem_alloc: >-
          {{ total_mem_alloc | float + (item.status.allocatable.memory | regex_replace('Ki','') | float * 1024) }}
        total_disk_alloc: >-
          {{ total_disk_alloc | float + (
             (item.status.allocatable['ephemeral-storage'] | regex_replace('Ki','') | float * 1024) 
             if 'Ki' in item.status.allocatable['ephemeral-storage'] 
             else item.status.allocatable['ephemeral-storage'] | float 
          ) }}
      loop: "{{ node_list.resources }}"
      loop_control:
        label: "Node: {{ item.metadata.name }}"

    # ==============================================================================
    # 3. CÁLCULOS DE CONSUMO (POD REQUESTS)
    # ==============================================================================
    - name: "3.1 Preparar Lista de Containers"
      set_fact:
        all_containers_list: "{{ all_pods.resources | map(attribute='spec.containers') | flatten }}"

    - name: "3.2 Somar Requests (Lógica Simplificada)"
      set_fact:
        # --- CPU ---
        used_cpu_req: >-
          {{
            used_cpu_req | float +
            (
              (cpu_val | regex_replace('m','') | float / 1000) 
              if 'm' in (cpu_val | string)
              else (cpu_val | float)
            )
          }}
        
        # --- MEMORY ---
        used_mem_req: >-
          {{
             used_mem_req | float +
             (
               (mem_val | regex_replace('Gi','') | float * 1073741824) if 'Gi' in (mem_val | string) else
               (mem_val | regex_replace('Mi','') | float * 1048576)    if 'Mi' in (mem_val | string) else
               (mem_val | regex_replace('Ki','') | float * 1024)       if 'Ki' in (mem_val | string) else
               (mem_val | float)
             )
          }}

        # --- DISK ---
        used_disk_req: >-
          {{
             used_disk_req | float +
             (
               (disk_val | regex_replace('Gi','') | float * 1073741824) if 'Gi' in (disk_val | string) else
               (disk_val | regex_replace('Mi','') | float * 1048576)    if 'Mi' in (disk_val | string) else
               (disk_val | regex_replace('Ki','') | float * 1024)       if 'Ki' in (disk_val | string) else
               (disk_val | float)
             )
          }}
      
      vars:
        cpu_val:  "{{ item.resources.requests.cpu | default('0') }}"
        mem_val:  "{{ item.resources.requests.memory | default('0') }}"
        disk_val: "{{ item.resources.requests['ephemeral-storage'] | default('0') }}"
      
      loop: "{{ all_containers_list }}"
      loop_control:
        label: "Math processing..."
      when: 
        - item.resources is defined
        - item.resources.requests is defined

    # ==============================================================================
    # 4. PREPARAR TEXTOS
    # ==============================================================================
    - name: "4.1 Definir Status SR-IOV"
      set_fact:
        sriov_messages: >-
          {{
            ['  ❌ ERRO: Operador SR-IOV não detectado ou sem permissão.']
            if sriov_policies.failed | default(false)
            else (
              (sriov_policies.resources | map(attribute='metadata.name') | map('regex_replace', '^', '  ⚡ Policy: ') | list)
              if (sriov_policies.resources | default([]) | length > 0)
              else ['  ⚠️  Nenhuma política
