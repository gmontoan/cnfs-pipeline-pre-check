---
- name: "Relat√≥rio v1: Capacidade Real"
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    cluster_stats:
      cpu_cap: 0
      cpu_alloc: 0
      mem_cap: 0
      mem_alloc: 0
      disk_cap: 0
      disk_alloc: 0
      hugepages_total_1gi: 0
      hugepages_free_1gi: 0
      hugepages_total_2mi: 0
      hugepages_free_2mi: 0
    formatted_profiles: []

  tasks:
    # ==============================================================================
    # FASE 1: COLETA
    # ==============================================================================
    - name: "1.1 Buscar Nodes"
      kubernetes.core.k8s_info:
        kind: Node
        api_version: v1
      register: node_list

    - name: "1.2 Buscar Configura√ß√£o de Rede"
      kubernetes.core.k8s_info:
        api_version: config.openshift.io/v1
        kind: Network
        name: cluster
      register: net_config

    - name: "1.3 Buscar SR-IOV e Perfis (Diagnostic Mode)"
      kubernetes.core.k8s_info:
        api_version: "{{ item.api }}"
        kind: "{{ item.kind }}"
        namespace: "{{ item.ns | default(omit) }}"
      loop:
        - { api: 'sriovnetwork.openshift.io/v1', kind: 'SriovNetworkNodePolicy', ns: 'openshift-sriov' }
        - { api: 'performance.openshift.io/v2', kind: 'PerformanceProfile' }
      register: k8s_extras
      failed_when: false

    # ==============================================================================
    # FASE 2: C√ÅLCULO (Soma Incremental)
    # ==============================================================================
    - name: "2.1 Processar Soma de Recursos"
      set_fact:
        cluster_stats:
          # CPU
          cpu_cap: >-
            {{ cluster_stats.cpu_cap | float + (item.status.capacity.cpu | regex_replace('m','') | float / 1000 if 'm' in item.status.capacity.cpu else item.status.capacity.cpu | float) }}
          cpu_alloc: >-
            {{ cluster_stats.cpu_alloc | float + (item.status.allocatable.cpu | regex_replace('m','') | float / 1000 if 'm' in item.status.allocatable.cpu else item.status.allocatable.cpu | float) }}
          
          # MEM√ìRIA
          mem_cap: >-
            {{ cluster_stats.mem_cap | float + (item.status.capacity.memory | regex_replace('Ki','') | float * 1024) }}
          mem_alloc: >-
            {{ cluster_stats.mem_alloc | float + (item.status.allocatable.memory | regex_replace('Ki','') | float * 1024) }}
          
          # DISCO (L√≥gica H√≠brida Ki/Bytes)
          disk_cap: >-
            {{ cluster_stats.disk_cap | float + (
               (item.status.capacity['ephemeral-storage'] | regex_replace('Ki','') | float * 1024) 
               if 'Ki' in item.status.capacity['ephemeral-storage'] 
               else item.status.capacity['ephemeral-storage'] | float 
            ) }}
          disk_alloc: >-
            {{ cluster_stats.disk_alloc | float + (
               (item.status.allocatable['ephemeral-storage'] | regex_replace('Ki','') | float * 1024) 
               if 'Ki' in item.status.allocatable['ephemeral-storage'] 
               else item.status.allocatable['ephemeral-storage'] | float 
            ) }}

          # HUGEPAGES
          hugepages_total_1gi: >-
            {{ cluster_stats.hugepages_total_1gi | float + (item.status.capacity['hugepages-1Gi'] | default('0') | regex_replace('Ki','') | float * 1024) }}
          hugepages_total_2mi: >-
            {{ cluster_stats.hugepages_total_2mi | float + (item.status.capacity['hugepages-2Mi'] | default('0') | regex_replace('Ki','') | float * 1024) }}

      loop: "{{ node_list.resources }}"
      loop_control:
        label: "Node: {{ item.metadata.name }}"

    - name: "2.2 Formatar Perfis de Performance"
      set_fact:
        formatted_profiles: "{{ formatted_profiles + ['  üöÄ Profile: ' ~ item.metadata.name ~ ' | Isolated: ' ~ (item.spec.cpu.isolated | default('N/A'))] }}"
      loop: "{{ k8s_extras.results[1].resources | default([]) }}"
      loop_control:
        label: "Profile: {{ item.metadata.name }}"

    # ==============================================================================
    # FASE 3: RELAT√ìRIO FINAL 
    # ==============================================================================
    
    - name: "CABE√áALHO"
      debug:
        msg: 
          - "############################################################"
          - "           RELAT√ìRIO DE CAPACIDADE "
          - "############################################################"

    # --- BLOCO 1: COMPUTA√á√ÉO ---
    - name: "üìä RELAT√ìRIO [1/4]: Computa√ß√£o"
      debug:
        msg:
          - "------------------------------------------------------------"
          - "CPU (vCores):"
          - "  üîπ Total F√≠sico (Capacity):    {{ cluster_stats.cpu_cap | float | round(1) }}"
          - "  üî∏ Dispon√≠vel Pods (Alloc):    {{ cluster_stats.cpu_alloc | float | round(1) }}"
          # CORRE√á√ÉO ABAIXO: Adicionado | float em cada vari√°vel antes da subtra√ß√£o
          - "  üîª Reservado Sistema:          {{ (cluster_stats.cpu_cap | float - cluster_stats.cpu_alloc | float) | round(1) }}"
          - " "
          - "MEM√ìRIA (RAM):"
          - "  üîπ Total F√≠sico:      {{ (cluster_stats.mem_cap | float / 1024**3) | round(2) }} GiB"
          - "  üî∏ Dispon√≠vel Pods:   {{ (cluster_stats.mem_alloc | float / 1024**3) | round(2) }} GiB"
          # CORRE√á√ÉO ABAIXO: Cast expl√≠cito antes do calculo
          - "  üîª Reservado Sistema: {{ ((cluster_stats.mem_cap | float - cluster_stats.mem_alloc | float) / 1024**3) | round(2) }} GiB"
          - "------------------------------------------------------------"

    # --- BLOCO 2: ARMAZENAMENTO ---
    - name: "üíæ RELAT√ìRIO [2/4]: Armazenamento (Ephemeral)"
      debug:
        msg:
          - "------------------------------------------------------------"
          - "  üîπ Total F√≠sico (Capacity):    {{ (cluster_stats.disk_cap | float / 1024**3) | round(2) }} GiB"
          - "  üî∏ Dispon√≠vel Pods (Alloc):    {{ (cluster_stats.disk_alloc | float / 1024**3) | round(2) }} GiB"
          # CORRE√á√ÉO ABAIXO: Cast expl√≠cito antes do calculo
          - "  üîª Reservado Sistema (Logs/OS):{{ ((cluster_stats.disk_cap | float - cluster_stats.disk_alloc | float) / 1024**3) | round(2) }} GiB"
          - "------------------------------------------------------------"

    # --- BLOCO 3: SR-IOV ---
    - name: "üåê RELAT√ìRIO [3/4]: Rede SR-IOV"
      debug:
        msg: "{{ header + status_msg + footer }}"
      vars:
        result_sriov: "{{ k8s_extras.results[0] }}"
        header: ["------------------------------------------------------------", "SR-IOV STATUS:"]
        status_msg: >-
          {{
            ['  ‚ùå ERRO DE API: ' ~ result_sriov.msg] if result_sriov.failed else
            ((result_sriov.resources | map(attribute='metadata.name') | map('regex_replace', '^', '  ‚ö° Policy: ') | list) if result_sriov.resources else ['  ‚ö†Ô∏è  Nenhuma pol√≠tica encontrada.'])
          }}
        footer: ["------------------------------------------------------------"]

    # --- BLOCO 4: TUNING ---
    - name: "‚ö° RELAT√ìRIO [4/4]: Tuning"
      debug:
        msg: "{{ header + status_msg + hugepages + footer }}"
      vars:
        result_perf: "{{ k8s_extras.results[1] }}"
        header: ["------------------------------------------------------------", "PERFORMANCE PROFILES:"]
        status_msg: >-
          {{
            ['  ‚ùå ERRO DE API: ' ~ result_perf.msg] if result_perf.failed else
            (formatted_profiles if formatted_profiles else ['  ‚ö†Ô∏è  Nenhum perfil aplicado.'])
          }}
        hugepages:
          - " "
          - "HUGEPAGES (Total Configurado):"
          - "  1Gi: {{ (cluster_stats.hugepages_total_1gi | float / 1024**3) | round(0) }} GiB"
          - "  2Mi: {{ (cluster_stats.hugepages_total_2mi | float / 1024**2) | round(0) }} MiB"
        footer: ["------------------------------------------------------------"]
    
    - name: "FIM"
      debug:
        msg: "############################################################"
