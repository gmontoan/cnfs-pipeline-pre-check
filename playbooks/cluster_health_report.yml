---
- name: "RelatÃ³rio AvanÃ§ado: Capacidade, Rede e Performance Tuning"
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    cluster_stats:
      cpu_cap: 0
      cpu_alloc: 0
      mem_cap: 0
      mem_alloc: 0
      disk_cap: 0
      disk_alloc: 0
      hugepages_total_1gi: 0
      hugepages_free_1gi: 0
      hugepages_total_2mi: 0
      hugepages_free_2mi: 0
    # Inicializa lista de perfis vazia
    formatted_profiles: []

  tasks:
    # ==============================================================================
    # FASE 1: COLETA DE DADOS
    # ==============================================================================
    - name: "1.1 Buscar Nodes"
      kubernetes.core.k8s_info:
        kind: Node
        api_version: v1
      register: node_list

    - name: "1.2 Buscar ConfiguraÃ§Ã£o de Rede (CNI)"
      kubernetes.core.k8s_info:
        api_version: config.openshift.io/v1
        kind: Network
        name: cluster
      register: net_config

    - name: "1.3 Buscar PolÃ­ticas SR-IOV"
      kubernetes.core.k8s_info:
        api_version: sriovnetwork.openshift.io/v1
        kind: SriovNetworkNodePolicy
        namespace: openshift-sriov
      register: sriov_policies
      ignore_errors: true

    - name: "1.4 Buscar Perfis de Performance"
      kubernetes.core.k8s_info:
        api_version: performance.openshift.io/v2
        kind: PerformanceProfile
      register: perf_profiles
      ignore_errors: true

    # ==============================================================================
    # FASE 2: CÃLCULO DE RECURSOS
    # ==============================================================================
    - name: "2.1 Processar Soma de Recursos"
      set_fact:
        cluster_stats:
          cpu_cap: >-
            {{ cluster_stats.cpu_cap | float + (item.status.capacity.cpu | regex_replace('m','') | float / 1000 if 'm' in item.status.capacity.cpu else item.status.capacity.cpu | float) }}
          cpu_alloc: >-
            {{ cluster_stats.cpu_alloc | float + (item.status.allocatable.cpu | regex_replace('m','') | float / 1000 if 'm' in item.status.allocatable.cpu else item.status.allocatable.cpu | float) }}
          mem_cap: >-
            {{ cluster_stats.mem_cap | float + (item.status.capacity.memory | regex_replace('Ki','') | float * 1024) }}
          mem_alloc: >-
            {{ cluster_stats.mem_alloc | float + (item.status.allocatable.memory | regex_replace('Ki','') | float * 1024) }}
          disk_cap: >-
            {{ cluster_stats.disk_cap | float + (item.status.capacity['ephemeral-storage'] | regex_replace('Ki','') | float * 1024) }}
          disk_alloc: >-
            {{ cluster_stats.disk_alloc | float + (item.status.allocatable['ephemeral-storage'] | regex_replace('Ki','') | float * 1024) }}
          hugepages_total_1gi: >-
            {{ cluster_stats.hugepages_total_1gi | float + (item.status.capacity['hugepages-1Gi'] | default('0') | regex_replace('Ki','') | float * 1024) }}
          hugepages_free_1gi: >-
            {{ cluster_stats.hugepages_free_1gi | float + (item.status.allocatable['hugepages-1Gi'] | default('0') | regex_replace('Ki','') | float * 1024) }}
          hugepages_total_2mi: >-
            {{ cluster_stats.hugepages_total_2mi | float + (item.status.capacity['hugepages-2Mi'] | default('0') | regex_replace('Ki','') | float * 1024) }}
          hugepages_free_2mi: >-
            {{ cluster_stats.hugepages_free_2mi | float + (item.status.allocatable['hugepages-2Mi'] | default('0') | regex_replace('Ki','') | float * 1024) }}
      loop: "{{ node_list.resources }}"
      loop_control:
        label: "Node: {{ item.metadata.name }}"

    # ==============================================================================
    # FASE 2.2: FORMATAÃ‡ÃƒO DE TEXTO (Sem dependÃªncias externas)
    # ==============================================================================
    - name: "2.2 Formatar Lista de Perfis de Performance"
      set_fact:
        formatted_profiles: "{{ formatted_profiles + ['  ðŸš€ Profile: ' ~ item.metadata.name ~ ' | Isolated CPUs: ' ~ (item.spec.cpu.isolated | default('N/A'))] }}"
      loop: "{{ perf_profiles.resources | default([]) }}"
      loop_control:
        label: "Profile: {{ item.metadata.name }}"
      when: perf_profiles.resources is defined

    # ==============================================================================
    # FASE 3: EXIBIÃ‡ÃƒO
    # ==============================================================================
    
    - name: "CABEÃ‡ALHO"
      debug:
        msg: 
          - "############################################################"
          - "      RELATÃ“RIO: CAPACIDADE & PERFORMANCE TUNING (RHBP)"
          - "############################################################"

    # --- BLOCO 1: COMPUTAÃ‡ÃƒO ---
    - name: "ðŸ“Š RELATÃ“RIO [1/4]: ComputaÃ§Ã£o"
      debug:
        msg:
          - "------------------------------------------------------------"
          - "CPU (vCores):"
          - "  ðŸ”¹ Capacity:    {{ cluster_stats.cpu_cap | float | round(1) }}"
          - "  ðŸ”¸ Allocatable: {{ cluster_stats.cpu_alloc | float | round(1) }}"
          - " "
          - "MEMÃ“RIA (RAM):"
          - "  ðŸ”¹ Capacity:    {{ (cluster_stats.mem_cap | float / 1024**3) | round(2) }} GiB"
          - "  ðŸ”¸ Allocatable: {{ (cluster_stats.mem_alloc | float / 1024**3) | round(2) }} GiB"
          - "------------------------------------------------------------"

    # --- BLOCO 2: ARMAZENAMENTO ---
    - name: "ðŸ’¾ RELATÃ“RIO [2/4]: Armazenamento (Ephemeral)"
      debug:
        msg:
          - "------------------------------------------------------------"
          - "  ðŸ”¹ Capacity:    {{ (cluster_stats.disk_cap | float / 1024**3) | round(2) }} GiB"
          - "  ðŸ”¸ Allocatable: {{ (cluster_stats.disk_alloc | float / 1024**3) | round(2) }} GiB"
          - "------------------------------------------------------------"

    # --- BLOCO 3
