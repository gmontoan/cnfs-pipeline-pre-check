---
- name: "Relatório Avançado: Capacidade, Rede e Performance Tuning"
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    # Estrutura para acumular dados
    cluster_stats:
      cpu_cap: 0
      cpu_alloc: 0
      mem_cap: 0
      mem_alloc: 0
      disk_cap: 0
      disk_alloc: 0
      hugepages_total_1gi: 0
      hugepages_free_1gi: 0
      hugepages_total_2mi: 0
      hugepages_free_2mi: 0

  tasks:
    # ==============================================================================
    # FASE 1: COLETA DE DADOS (Infraestrutura)
    # ==============================================================================
    - name: "1.1 Buscar Nodes"
      kubernetes.core.k8s_info:
        kind: Node
        api_version: v1
      register: node_list

    - name: "1.2 Buscar Configuração de Rede (CNI)"
      kubernetes.core.k8s_info:
        api_version: config.openshift.io/v1
        kind: Network
        name: cluster
      register: net_config

    - name: "1.3 Buscar Políticas SR-IOV"
      kubernetes.core.k8s_info:
        api_version: sriovnetwork.openshift.io/v1
        kind: SriovNetworkNodePolicy
        namespace: openshift-sriov
      register: sriov_policies
      ignore_errors: true

    - name: "1.4 Buscar Perfis de Performance (Node Tuning Operator)"
      kubernetes.core.k8s_info:
        api_version: performance.openshift.io/v2
        kind: PerformanceProfile
      register: perf_profiles
      ignore_errors: true

    # ==============================================================================
    # FASE 2: CÁLCULO DE RECURSOS E TUNING
    # ==============================================================================
    - name: "2. Processar Soma de Recursos (Incluindo HugePages)"
      set_fact:
        cluster_stats:
          # --- CPU e Memória (Padrão) ---
          cpu_cap:   "{{ cluster_stats.cpu_cap   | float + (item.status.capacity.cpu | regex_replace('m','') | float / 1000 if 'm' in item.status.capacity.cpu else item.status.capacity.cpu | float) }}"
          cpu_alloc: "{{ cluster_stats.cpu_alloc | float + (item.status.allocatable.cpu | regex_replace('m','') | float / 1000 if 'm' in item.status.allocatable.cpu else item.status.allocatable.cpu | float) }}"
          mem_cap:   "{{ cluster_stats.mem_cap   | float + (item.status.capacity.memory | regex_replace('Ki','') | float * 1024) }}"
          mem_alloc: "{{ cluster_stats.mem_alloc | float + (item.status.allocatable.memory | regex_replace('Ki','') | float * 1024) }}"
          
          # --- DISCO (Ephemeral Storage) ---
          disk_cap:  "{{ cluster_stats.disk_cap  | float + (item.status.capacity['ephemeral-storage'] | regex_replace('Ki','') | float * 1024) }}"
          # A CORREÇÃO ESTÁ NA LINHA ABAIXO (Adicionado espaço após disk_alloc:)
          disk_alloc: "{{ cluster_stats.disk_alloc | float + (item.status.allocatable['ephemeral-storage'] | regex_replace('Ki','') | float * 1024) }}"
          
          # --- PERFORMANCE TUNING: HugePages (1Gi e 2Mi) ---
          hugepages_total_1gi: "{{ cluster_stats.hugepages_total_1gi | float + (item.status.capacity['hugepages-1Gi'] | default('0') | regex_replace('Ki','') | float * 1024) }}"
          hugepages_free_1gi:  "{{ cluster_stats.hugepages_free_1gi  | float + (item.status.allocatable['hugepages-1Gi'] | default('0') | regex_replace('Ki','') | float * 1024) }}"
          hugepages_total_2mi: "{{ cluster_stats.hugepages_total_2mi | float + (item.status.capacity['hugepages-2Mi'] | default('0') | regex_replace('Ki','') | float * 1024) }}"
          hugepages_free_2mi:  "{{ cluster_stats.hugepages_free_2mi  | float + (item.status.allocatable['hugepages-2Mi'] |
