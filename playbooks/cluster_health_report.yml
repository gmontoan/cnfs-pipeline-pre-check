---
- name: "Relat칩rio v13: Uso Real (Fix Loop)"
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    total_cpu_allocatable: 0
    total_mem_allocatable: 0
    used_cpu_requests: 0
    used_mem_requests: 0
    # Lista tempor치ria para facilitar o loop
    all_containers_list: []

  tasks:
    # ==============================================================================
    # 1. COLETAR DADOS
    # ==============================================================================
    - name: "1.1 Buscar Nodes"
      kubernetes.core.k8s_info:
        kind: Node
        api_version: v1
      register: node_list

    - name: "1.2 Buscar TODOS os Pods (Running)"
      kubernetes.core.k8s_info:
        kind: Pod
        api_version: v1
        field_selectors:
          - status.phase=Running
      register: all_pods

    # ==============================================================================
    # 2. CALCULAR CAPACIDADE DOS NODES (Hardware)
    # ==============================================================================
    - name: "2.1 Somar Capacidade dos Nodes"
      set_fact:
        total_cpu_allocatable: >-
          {{ total_cpu_allocatable | float + (item.status.allocatable.cpu | regex_replace('m','') | float / 1000 if 'm' in item.status.allocatable.cpu else item.status.allocatable.cpu | float) }}
        total_mem_allocatable: >-
          {{ total_mem_allocatable | float + (item.status.allocatable.memory | regex_replace('Ki','') | float * 1024) }}
      loop: "{{ node_list.resources }}"
      loop_control:
        label: "Node: {{ item.metadata.name }}"

    # ==============================================================================
    # 3. PREPARAR LISTA DE CONTAINERS (Corre칞칚o do Bug)
    # ==============================================================================
    - name: "3.1 Extrair e Achatar Lista de Containers"
      set_fact:
        # Pega a lista de pods, extrai 'spec.containers' de cada um e achata numa lista 칰nica
        all_containers_list: "{{ all_pods.resources | map(attribute='spec.containers') | flatten }}"

    # ==============================================================================
    # 4. SOMAR REQUESTS (Loop na lista correta)
    # ==============================================================================
    - name: "4.1 Somar Requests de CPU e Mem칩ria"
      set_fact:
        used_cpu_requests: >-
          {{
            used_cpu_requests | float +
            (
              (item.resources.requests.cpu | default('0') | regex_replace('m','') | float / 1000) 
              if 'm' in (item.resources.requests.cpu | default('0') | string)
              else (item.resources.requests.cpu | default('0') | float)
            )
          }}
        used_mem_requests: >-
          {{
             used_mem_requests | float +
             (
               (item.resources.requests.memory | default('0') | regex_replace('Gi','') | float * 1024**3) if 'Gi' in (item.resources.requests.memory | default('0') | string) else
               (item.resources.requests.memory | default('0') | regex_replace('Mi','') | float * 1024**2) if 'Mi' in (item.resources.requests.memory | default('0') | string) else
               (item.resources.requests.memory | default('0') | regex_replace('Ki','') | float * 1024)    if 'Ki' in (item.resources.requests.memory | default('0') | string) else
               (item.resources.requests.memory | default('0') | float)
             )
          }}
      # Filtra apenas containers que tenham 'requests' definidos para evitar erros
      loop: "{{ all_containers_list }}"
      loop_control:
        label: "Processing container resource math..."
      when: 
        - item.resources is defined
        - item.resources.requests is defined

    # ==============================================================================
    # 5. EXIBIR RELAT칍RIO
    # ==============================================================================
    - name: "游늵 RELAT칍RIO DE DISPONIBILIDADE REAL (LIVRE PARA NOVO DEPLOY)"
      debug:
        msg:
          - "############################################################"
          - "      CAPACIDADE REAL (DISPON칈VEL AGORA)"
          - "############################################################"
          - "Nodes Ativos: {{ node_list.resources | length }} | Pods Rodando: {{ all_pods.resources | length }} | Containers: {{ all_containers_list | length }}"
          - "------------------------------------------------------------"
          - "CPU (Cores):"
          - "  游댳 Total Cluster (Allocatable):  {{ total_cpu_allocatable | float | round(1) }}"
          - "  游댲 Usado por Pods (Requests):    {{ used_cpu_requests | float | round(1) }}"
          - "  游릭 LIVRE PARA USO:               {{ (total_cpu_allocatable | float - used_cpu_requests | float) | round(1) }}"
          - "  游늵 Porcentagem Livre:            {{ (((total_cpu_allocatable | float - used_cpu_requests | float) / total_cpu_allocatable | float) * 100) | round(1) }}%"
          - " "
          - "MEM칍RIA (GiB):"
          - "  游댳 Total Cluster (Allocatable):  {{ (total_mem_allocatable | float / 1024**3) | round(2) }} GiB"
          - "  游댲 Usado por Pods (Requests):    {{ (used_mem_requests | float / 1024**3) | round(2) }} GiB"
          - "  游릭 LIVRE PARA USO:               {{ ((total_mem_allocatable | float - used_mem_requests | float) / 1024**3) | round(2) }} GiB"
          - "  游늵 Porcentagem Livre:            {{ (((total_mem_allocatable | float - used_mem_requests | float) / total_mem_allocatable | float) * 100) | round(1) }}%"
          - "############################################################"
