---
- name: "Relat√≥rio v12: Uso Real vs Capacidade (Requests)"
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    # Totais de Hardware (Capacidade)
    total_cpu_allocatable: 0
    total_mem_allocatable: 0
    
    # Totais Consumidos pelos Pods (Requests)
    used_cpu_requests: 0
    used_mem_requests: 0

  tasks:
    # ==============================================================================
    # 1. COLETAR DADOS (NODES + PODS)
    # ==============================================================================
    - name: "1.1 Buscar Nodes (Hardware)"
      kubernetes.core.k8s_info:
        kind: Node
        api_version: v1
      register: node_list

    - name: "1.2 Buscar TODOS os Pods (Carga de Trabalho)"
      kubernetes.core.k8s_info:
        kind: Pod
        api_version: v1
        field_selectors:
          - status.phase=Running
      register: all_pods

    # ==============================================================================
    # 2. CALCULAR CAPACIDADE DO HARDWARE (Igual ao anterior)
    # ==============================================================================
    - name: "2.1 Somar Capacidade dos Nodes"
      set_fact:
        total_cpu_allocatable: >-
          {{ total_cpu_allocatable | float + (item.status.allocatable.cpu | regex_replace('m','') | float / 1000 if 'm' in item.status.allocatable.cpu else item.status.allocatable.cpu | float) }}
        total_mem_allocatable: >-
          {{ total_mem_allocatable | float + (item.status.allocatable.memory | regex_replace('Ki','') | float * 1024) }}
      loop: "{{ node_list.resources }}"
      loop_control:
        label: "Node: {{ item.metadata.name }}"

    # ==============================================================================
    # 3. CALCULAR CONSUMO DOS PODS (A M√ÅGICA ACONTECE AQUI)
    # ==============================================================================
    # Esta task varre cada container de cada pod rodando e soma os 'requests'
    - name: "3.1 Somar Requests dos Pods"
      set_fact:
        used_cpu_requests: >-
          {{
            used_cpu_requests | float +
            (container.resources.requests.cpu | default('0') | regex_replace('m','') | float / 1000 if 'm' in (container.resources.requests.cpu | default('0')) 
             else container.resources.requests.cpu | default('0') | float)
          }}
        used_mem_requests: >-
          {{
             used_mem_requests | float +
             (
               (container.resources.requests.memory | default('0') | regex_replace('Gi','') | float * 1024 * 1024 * 1024) if 'Gi' in (container.resources.requests.memory | default('0')) else
               (container.resources.requests.memory | default('0') | regex_replace('Mi','') | float * 1024 * 1024) if 'Mi' in (container.resources.requests.memory | default('0')) else
               (container.resources.requests.memory | default('0') | regex_replace('Ki','') | float * 1024) if 'Ki' in (container.resources.requests.memory | default('0')) else
               container.resources.requests.memory | default('0') | float
             )
          }}
      loop: "{{ all_pods.resources | subelements('spec.containers') }}"
      loop_control:
        loop_var: container
        label: "Processing container"

    # ==============================================================================
    # 4. EXIBIR RELAT√ìRIO DE "SOBRAS"
    # ==============================================================================
    - name: "üìä RELAT√ìRIO DE DISPONIBILIDADE REAL (LIVRE PARA NOVO DEPLOY)"
      debug:
        msg:
          - "############################################################"
          - "      CAPACIDADE REAL (DISPON√çVEL AGORA)"
          - "############################################################"
          - "Nodes Ativos: {{ node_list.resources | length }} | Pods Rodando: {{ all_pods.resources | length }}"
          - "------------------------------------------------------------"
          - "CPU (Cores):"
          - "  üîπ Total Cluster (Allocatable):  {{ total_cpu_allocatable | float | round(1) }}"
          - "  üî∏ Usado por Pods (Requests):    {{ used_cpu_requests | float | round(1) }}"
          - "  üü¢ LIVRE PARA USO:               {{ (total_cpu_allocatable | float - used_cpu_requests | float) | round(1) }}"
          - "  üìä Porcentagem Livre:            {{ (((total_cpu_allocatable | float - used_cpu_requests | float) / total_cpu_allocatable | float) * 100) | round(1) }}%"
          - " "
          - "MEM√ìRIA (GiB):"
          - "  üîπ Total Cluster (Allocatable):  {{ (total_mem_allocatable | float / 1024**3) | round(2) }} GiB"
          - "  üî∏ Usado por Pods (Requests):    {{ (used_mem_requests | float / 1024**3) | round(2) }} GiB"
          - "  üü¢ LIVRE PARA USO:               {{ ((total_mem_allocatable | float - used_mem_requests | float) / 1024**3) | round(2) }} GiB"
          - "  üìä Porcentagem Livre:            {{ (((total_mem_allocatable | float - used_mem_requests | float) / total_mem_allocatable | float) * 100) | round(1) }}%"
          - "############################################################"
